<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bản đồ Offline</title>

    <!-- Leaflet CSS - Đường dẫn tương đối -->
    <link rel="stylesheet" href="lib/leaflet.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        height: 100vh;
        margin: 0;
        padding: 0;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      .info-box {
        position: absolute;
        top: 80px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-width: 300px;
      }

      .info-box h3 {
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .info-box p {
        font-size: 12px;
        color: #666;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Leaflet JS - Đường dẫn tương đối -->
    <script src="lib/leaflet.js"></script>
    <!-- JSZip để xử lý file KMZ (KMZ là file KML được nén zip) -->
    <script src="lib/jszip.min.js"></script>
    <!-- toGeoJSON để chuyển đổi KML sang GeoJSON -->
    <script src="lib/togeojson.js"></script>

    <script>
      // Lấy tham số từ URL query
      const urlParams = new URLSearchParams(window.location.search)
      const lat = parseFloat(urlParams.get('lat')) || 16.0544 // Vĩ độ mặc định
      const lng = parseFloat(urlParams.get('lng')) || 108.2022 // Kinh độ mặc định
      const zoom = parseInt(urlParams.get('zoom')) || 6 // Zoom mặc định

      // Khởi tạo bản đồ với tọa độ từ query hoặc mặc định
      const map = L.map('map').setView([lat, lng], zoom)

      // Sử dụng tiles OFFLINE đã tải về
      // Tiles được lưu trong thư mục tiles/ theo cấu trúc: tiles/{z}/{x}/{y}.png
      L.tileLayer('tiles/{z}/{x}/{y}.png', {
        maxZoom: 12, // Phải khớp với MAX_ZOOM trong download_tiles.py
        minZoom: 4, // Phải khớp với MIN_ZOOM trong download_tiles.py
        attribution: '© OpenStreetMap contributors',
        errorTileUrl:
          'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==', // Tile trong suốt khi không tìm thấy
      }).addTo(map)

      // CHÚ Ý: Bản đồ này hoạt động HOÀN TOÀN OFFLINE
      // Để tải tiles, chạy: python download_tiles.py

      // Hàm tải và hiển thị file KMZ
      async function loadKMZ(url) {
        try {
          const response = await fetch(url)
          const arrayBuffer = await response.arrayBuffer()

          // Giải nén KMZ
          const zip = await JSZip.loadAsync(arrayBuffer)

          // Tìm file KML trong KMZ (thường là doc.kml)
          let kmlFile = null
          for (let filename in zip.files) {
            if (filename.endsWith('.kml')) {
              kmlFile = zip.files[filename]
              break
            }
          }

          if (!kmlFile) {
            throw new Error('Không tìm thấy file KML trong KMZ')
          }

          // Đọc nội dung KML
          const kmlText = await kmlFile.async('string')

          // Parse KML thành XML
          const parser = new DOMParser()
          const kmlDoc = parser.parseFromString(kmlText, 'text/xml')

          // Chuyển đổi KML sang GeoJSON
          const geoJson = toGeoJSON.kml(kmlDoc)

          // Thêm GeoJSON lên bản đồ
          const geoJsonLayer = L.geoJSON(geoJson, {
            onEachFeature: function (feature, layer) {
              // Thêm popup với thông tin
              if (feature.properties) {
                let popupContent = '<div style="max-width: 200px;">'
                for (let key in feature.properties) {
                  if (feature.properties[key]) {
                    popupContent += `<b>${key}:</b> ${feature.properties[key]}<br>`
                  }
                }
                popupContent += '</div>'
                layer.bindPopup(popupContent)
              }
            },
          }).addTo(map)

          // Chỉ zoom đến vùng dữ liệu nếu không có query parameters
          const urlParams = new URLSearchParams(window.location.search)
          if (!urlParams.has('lat') && !urlParams.has('lng')) {
            map.fitBounds(geoJsonLayer.getBounds())
          }

          console.log('Đã tải KMZ thành công!')
        } catch (error) {
          console.error('Lỗi khi tải KMZ:', error)
          alert(
            'Không thể tải file data.kmz. Đảm bảo file tồn tại và các thư viện đã được cài đặt đúng.'
          )
        }
      }

      // Tải file KMZ khi trang được load
      // Đảm bảo file data.kmz nằm cùng thư mục với index.html
      // loadKMZ('biengioi.kmz')

      // Thêm scale control
      L.control
        .scale({
          imperial: false,
          metric: true,
        })
        .addTo(map)
    </script>
  </body>
</html>
