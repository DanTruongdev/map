<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bản đồ Offline</title>

    <!-- Leaflet CSS - Đường dẫn tương đối -->
    <link rel="stylesheet" href="lib/leaflet.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      #controls {
        padding: 15px;
        background: #2c3e50;
        color: white;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      #controls label {
        font-weight: bold;
      }

      #coordInput {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #3498db;
        border-radius: 4px;
        font-size: 14px;
      }

      #searchButton {
        padding: 8px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      #searchButton:hover {
        background: #2980b9;
      }

      #map {
        flex: 1;
        width: 100%;
      }

      .info-box {
        position: absolute;
        top: 80px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-width: 300px;
      }

      .info-box h3 {
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .info-box p {
        font-size: 12px;
        color: #666;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label for="coordInput">Tọa độ (Vĩ độ, Kinh độ):</label>
      <input
        type="text"
        id="coordInput"
        placeholder="Ví dụ: 21.0285, 105.8542 (Hà Nội)"
      />
      <button id="searchButton">Tìm kiếm</button>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS - Đường dẫn tương đối -->
    <script src="lib/leaflet.js"></script>
    <!-- JSZip để xử lý file KMZ (KMZ là file KML được nén zip) -->
    <script src="lib/jszip.min.js"></script>
    <!-- toGeoJSON để chuyển đổi KML sang GeoJSON -->
    <script src="lib/togeojson.js"></script>

    <script>
      // Khởi tạo bản đồ với tọa độ trung tâm Việt Nam
      const map = L.map('map').setView([16.0544, 108.2022], 6)

      // Thêm tile layer với OpenStreetMap tiles
      // Đây là tiles mặc định để hiển thị bản đồ nền
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors',
      }).addTo(map)

      // ĐỂ SỬ DỤNG HOÀN TOÀN OFFLINE:
      // 1. Tải tiles về máy bằng MOBAC hoặc công cụ tương tự
      // 2. Thay đổi URL thành: 'tiles/{z}/{x}/{y}.png'
      // 3. Đặt tiles vào thư mục tiles/ theo cấu trúc: tiles/zoom/x/y.png

      // Biến lưu marker tìm kiếm
      let searchMarker = null

      // Hàm tải và hiển thị file KMZ
      async function loadKMZ(url) {
        try {
          const response = await fetch(url)
          const arrayBuffer = await response.arrayBuffer()

          // Giải nén KMZ
          const zip = await JSZip.loadAsync(arrayBuffer)

          // Tìm file KML trong KMZ (thường là doc.kml)
          let kmlFile = null
          for (let filename in zip.files) {
            if (filename.endsWith('.kml')) {
              kmlFile = zip.files[filename]
              break
            }
          }

          if (!kmlFile) {
            throw new Error('Không tìm thấy file KML trong KMZ')
          }

          // Đọc nội dung KML
          const kmlText = await kmlFile.async('string')

          // Parse KML thành XML
          const parser = new DOMParser()
          const kmlDoc = parser.parseFromString(kmlText, 'text/xml')

          // Chuyển đổi KML sang GeoJSON
          const geoJson = toGeoJSON.kml(kmlDoc)

          // Thêm GeoJSON lên bản đồ
          const geoJsonLayer = L.geoJSON(geoJson, {
            onEachFeature: function (feature, layer) {
              // Thêm popup với thông tin
              if (feature.properties) {
                let popupContent = '<div style="max-width: 200px;">'
                for (let key in feature.properties) {
                  if (feature.properties[key]) {
                    popupContent += `<b>${key}:</b> ${feature.properties[key]}<br>`
                  }
                }
                popupContent += '</div>'
                layer.bindPopup(popupContent)
              }
            },
          }).addTo(map)

          // Zoom đến vùng dữ liệu
          map.fitBounds(geoJsonLayer.getBounds())

          console.log('Đã tải KMZ thành công!')
        } catch (error) {
          console.error('Lỗi khi tải KMZ:', error)
          alert(
            'Không thể tải file data.kmz. Đảm bảo file tồn tại và các thư viện đã được cài đặt đúng.'
          )
        }
      }

      // Hàm tìm kiếm tọa độ
      function searchCoordinates() {
        const input = document.getElementById('coordInput').value.trim()

        // Phân tích cú pháp đầu vào (Vĩ độ, Kinh độ)
        const coords = input.split(',').map((c) => parseFloat(c.trim()))

        if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
          alert(
            'Vui lòng nhập tọa độ hợp lệ theo định dạng: Vĩ độ, Kinh độ\nVí dụ: 21.0285, 105.8542'
          )
          return
        }

        const lat = coords[0]
        const lng = coords[1]

        // Kiểm tra tọa độ hợp lệ
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          alert(
            'Tọa độ không hợp lệ!\nVĩ độ phải từ -90 đến 90\nKinh độ phải từ -180 đến 180'
          )
          return
        }

        // Xóa marker cũ nếu có
        if (searchMarker) {
          map.removeLayer(searchMarker)
        }

        // Tạo marker mới
        searchMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl:
              'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjRUE0MzM1IiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi43IDAuNyAzLjlsMTEuOCAyNC42IDExLjgtMjQuNmMwLjQtMS4yIDAuNy0yLjUgMC43LTMuOUMyNSA1LjYgMTkuNCAwIDEyLjUgMHptMCAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjUtMiA0LjUtNC41IDQuNXoiLz48L3N2Zz4=',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
          }),
        }).addTo(map)

        // Thêm popup
        searchMarker
          .bindPopup(
            `
                <b>Vị trí tìm kiếm</b><br>
                Vĩ độ: ${lat.toFixed(6)}<br>
                Kinh độ: ${lng.toFixed(6)}
            `
          )
          .openPopup()

        // Di chuyển bản đồ đến tọa độ
        map.setView([lat, lng], 15)
      }

      // Xử lý sự kiện click nút tìm kiếm
      document
        .getElementById('searchButton')
        .addEventListener('click', searchCoordinates)

      // Xử lý sự kiện nhấn Enter trong ô input
      document
        .getElementById('coordInput')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            searchCoordinates()
          }
        })

      // Tải file KMZ khi trang được load
      // Đảm bảo file data.kmz nằm cùng thư mục với index.html
      loadKMZ('data2.kmz')

      // Thêm scale control
      L.control
        .scale({
          imperial: false,
          metric: true,
        })
        .addTo(map)
    </script>
  </body>
</html>
